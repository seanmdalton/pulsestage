#!/usr/bin/env sh

echo "ğŸ” Running pre-push checks..."

# Check if Docker services are running (check for database port)
if nc -z localhost 5432 2>/dev/null; then
  echo "ğŸ§ª Running API tests..."
  (cd api && npm run test)
  API_TEST_EXIT_CODE=$?
  
  if [ $API_TEST_EXIT_CODE -ne 0 ]; then
    echo "âŒ API tests failed. Please fix the test failures before pushing."
    exit 1
  fi
else
  echo "âš ï¸  Docker services not running - skipping tests"
  echo "ğŸ’¡ Start services with: docker compose up"
  echo "   Tests will still run in CI pipeline"
fi

echo "ğŸ”¨ Building API..."
(cd api && npm run build)
API_BUILD_EXIT_CODE=$?

if [ $API_BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ API build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "ğŸ“ Checking API code quality..."
(cd api && npm run lint)
API_LINT_EXIT_CODE=$?

# Only fail if there are actual errors (exit code 1), not warnings (exit code 2)
if [ $API_LINT_EXIT_CODE -eq 1 ]; then
  echo "âŒ API linting failed with errors. Please fix the errors before pushing."
  echo "ğŸ’¡ Warnings are allowed but errors must be fixed."
  exit 1
fi

echo "ğŸ”¨ Building Web..."
(cd web && npm run build)
WEB_BUILD_EXIT_CODE=$?

if [ $WEB_BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Web build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "ğŸ“ Checking Web code quality..."
(cd web && npm run lint -- --max-warnings=-1)
WEB_LINT_EXIT_CODE=$?

# Fail on any linting issues (errors)
if [ $WEB_LINT_EXIT_CODE -ne 0 ]; then
  echo "âŒ Web linting failed. Please fix the errors before pushing."
  exit 1
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ‰ API tests, builds (API + Web), and linting all successful!"
