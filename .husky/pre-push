#!/usr/bin/env sh

echo "ğŸ” Running pre-push checks..."

# Run API tests and build to ensure everything works
echo "ğŸ§ª Running API tests..."
(cd api && npm run test)
API_TEST_EXIT_CODE=$?

if [ $API_TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ API tests failed. Please fix the test failures before pushing."
  exit 1
fi

echo "ğŸ”¨ Building API..."
(cd api && npm run build)
API_BUILD_EXIT_CODE=$?

if [ $API_BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ API build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "ğŸ“ Checking API code quality..."
(cd api && npm run lint)
API_LINT_EXIT_CODE=$?

# Only fail if there are actual errors (exit code 1), not warnings (exit code 2)
if [ $API_LINT_EXIT_CODE -eq 1 ]; then
  echo "âŒ API linting failed with errors. Please fix the errors before pushing."
  echo "ğŸ’¡ Warnings are allowed but errors must be fixed."
  exit 1
fi

echo "ğŸ”¨ Building Web..."
(cd web && npm run build)
WEB_BUILD_EXIT_CODE=$?

if [ $WEB_BUILD_EXIT_CODE -ne 0 ]; then
  echo "âŒ Web build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "ğŸ“ Checking Web code quality..."
(cd web && npm run lint)
WEB_LINT_EXIT_CODE=$?

# Only fail if there are actual errors (exit code 1), not warnings (exit code 2)
if [ $WEB_LINT_EXIT_CODE -eq 1 ]; then
  echo "âŒ Web linting failed with errors. Please fix the errors before pushing."
  echo "ğŸ’¡ Warnings are allowed but errors must be fixed."
  exit 1
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ‰ API tests, builds (API + Web), and linting all successful!"
