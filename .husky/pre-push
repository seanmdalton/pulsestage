#!/usr/bin/env sh

echo "🔍 Running pre-push checks..."

# Run API tests and build to ensure everything works
echo "🧪 Running API tests..."
(cd api && npm run test)
API_TEST_EXIT_CODE=$?

if [ $API_TEST_EXIT_CODE -ne 0 ]; then
  echo "❌ API tests failed. Please fix the test failures before pushing."
  exit 1
fi

echo "🔨 Building API..."
(cd api && npm run build)
API_BUILD_EXIT_CODE=$?

if [ $API_BUILD_EXIT_CODE -ne 0 ]; then
  echo "❌ API build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "📝 Checking API code quality..."
(cd api && npm run lint)
API_LINT_EXIT_CODE=$?

# Only fail if there are actual errors (exit code 1), not warnings (exit code 2)
if [ $API_LINT_EXIT_CODE -eq 1 ]; then
  echo "❌ API linting failed with errors. Please fix the errors before pushing."
  echo "💡 Warnings are allowed but errors must be fixed."
  exit 1
fi

echo "🔨 Building Web..."
(cd web && npm run build)
WEB_BUILD_EXIT_CODE=$?

if [ $WEB_BUILD_EXIT_CODE -ne 0 ]; then
  echo "❌ Web build failed. Please fix the build errors before pushing."
  exit 1
fi

echo "📝 Checking Web code quality..."
(cd web && npm run lint)
WEB_LINT_EXIT_CODE=$?

# Only fail if there are actual errors (exit code 1), not warnings (exit code 2)
if [ $WEB_LINT_EXIT_CODE -eq 1 ]; then
  echo "❌ Web linting failed with errors. Please fix the errors before pushing."
  echo "💡 Warnings are allowed but errors must be fixed."
  exit 1
fi

echo "✅ All pre-push checks passed!"
echo "🎉 API tests, builds (API + Web), and linting all successful!"
