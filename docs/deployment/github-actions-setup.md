# GitHub Actions Setup for Demo Reset

## Problem
The demo reset GitHub Action is failing with `401 Unauthorized` because the `DEMO_ADMIN_KEY` secret needs to be set up correctly.

## Solution

### Step 1: Get the ADMIN_KEY from Render

1. Go to [Render Dashboard](https://dashboard.render.com/)
2. Navigate to your `pulsestage-demo-api` service
3. Click on **Environment** in the left sidebar
4. Find the `ADMIN_KEY` variable
5. Click the **eye icon** to reveal the value
6. **Copy the entire value** (it should be a long random string)

Example format: `7KxZJaIWjWql9B3p96OZK6_oAoEiNYNK` (yours will be different)

### Step 2: Add the Secret to GitHub

1. Go to your GitHub repository: https://github.com/seanmdalton/pulsestage
2. Click **Settings** (repo settings, not your account)
3. In the left sidebar, click **Secrets and variables** → **Actions**
4. Click **New repository secret**
5. Fill in:
   - **Name**: `DEMO_ADMIN_KEY` (must be exact)
   - **Secret**: Paste the value you copied from Render
6. Click **Add secret**

### Step 3: Verify the Secret

1. Go to **Actions** tab in your repo
2. Click on **Demo Reset** workflow in the left sidebar
3. Click **Run workflow** → **Run workflow**
4. Wait a few seconds and check the result

**Expected Success Output:**
```
Response: {"success":true,"message":"Demo instance fully reset successfully",...}
HTTP Status: 200
✅ Demo reset successful!
```

**If it still fails with 401:**
- Double-check you copied the ENTIRE key from Render (no spaces, no line breaks)
- Make sure the secret name is exactly `DEMO_ADMIN_KEY`
- Verify the key in Render hasn't changed

### Step 4: Test Locally (Optional)

You can test the endpoint locally to verify your key works:

```bash
# Replace YOUR_ADMIN_KEY with the key from Render
curl -X POST \
  -H "x-admin-key: YOUR_ADMIN_KEY" \
  https://api-demo.pulsestage.app/admin/reset-demo
```

**Expected response:**
```json
{
  "success": true,
  "message": "Demo instance fully reset successfully",
  "timestamp": "2025-10-16T...",
  "resetItems": {
    "questionsCleared": 97,
    "upvotesCleared": 1,
    "auditLogsCleared": 29,
    "teamMembershipsCleared": 5,
    "userPreferencesCleared": 4,
    "usersCleared": 4,
    "tagsCleared": 6,
    "teamsCleared": 3,
    "demoDataReseeded": true
  }
}
```

## Troubleshooting

### Error: "Invalid or missing admin key"

**Cause**: The key doesn't match what's in Render's `ADMIN_KEY` environment variable.

**Solution**:
1. Re-copy the key from Render (click the eye icon to reveal)
2. Delete the old GitHub secret
3. Create a new one with the correct value

### Error: "Demo mode is not enabled"

**Cause**: The demo endpoint only works when `AUTH_MODE_DEMO=true`.

**Solution**: Check Render environment has `AUTH_MODE_DEMO=true` set.

### Workflow doesn't show up

**Cause**: The workflow file might not be pushed to GitHub yet.

**Solution**: 
```bash
git pull origin main
# Check if .github/workflows/demo-reset.yaml exists
```

## Schedule

The demo reset runs automatically:
- **Daily at 6 AM UTC** (2 AM EST, 11 PM PST)
- Can also be triggered **manually** via Actions tab

## Security Note

The `DEMO_ADMIN_KEY` should:
- ✅ Be a secure random string (generated by Render)
- ✅ Only be used for demo instance operations
- ✅ Never be committed to git
- ✅ Be rotated periodically (update both Render and GitHub when rotated)

