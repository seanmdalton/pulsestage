<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mock SSO Testing - PulseStage (Multi-Tenant)</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .user-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.2s;
      }
      .user-card:hover {
        border-color: #3b82f6;
        background: #f8faff;
      }
      .user-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
      }
      .user-name {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 5px;
      }
      .user-email {
        color: #666;
        margin-bottom: 10px;
      }
      .user-role {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
      }
      .role-admin {
        background: #fef3c7;
        color: #92400e;
      }
      .role-member {
        background: #d1fae5;
        color: #065f46;
      }
      .role-moderator {
        background: #d9f99d;
        color: #3f6212;
      }
      .role-owner {
        background: #e0e7ff;
        color: #3730a3;
      }
      .role-viewer {
        background: #e5e7eb;
        color: #374151;
      }
      .teams {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }
      .button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px 5px;
      }
      .button:hover {
        background: #2563eb;
      }
      .button.secondary {
        background: #6b7280;
      }
      .button.secondary:hover {
        background: #4b5563;
      }
      .button:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }
      .status {
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .status.info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #bfdbfe;
      }
      .instructions {
        background: #f3f4f6;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 30px;
      }
      .instructions h3 {
        margin-top: 0;
        color: #374151;
      }
      .tenant-selector {
        background: #eff6ff;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .tenant-selector label {
        font-weight: 600;
        font-size: 16px;
        display: block;
        margin-bottom: 10px;
      }
      .tenant-selector select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: white;
      }
      .current-context {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        font-weight: 500;
        color: #065f46;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }
      .spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Mock SSO Testing (Multi-Tenant)</h1>

      <div class="instructions">
        <h3>Demo User Selection</h3>
        <p>Select a tenant and user below to sign in and explore PulseStage.</p>

        <h4>Multi-Tenancy Notes:</h4>
        <ul>
          <li>Users are permanently bound to their tenant</li>
          <li>You cannot switch tenants with the same user</li>
          <li>Each tenant has its own set of users, teams, and data</li>
        </ul>
      </div>

      <div id="tenantSelector" style="display: none" class="tenant-selector">
        <label for="tenantSelect">Select Tenant:</label>
        <select id="tenantSelect" onchange="onTenantChange()">
          <option value="">-- Select a tenant --</option>
        </select>
      </div>

      <div id="loading" class="loading" style="display: none">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>

      <div id="status"></div>

      <div id="usersList" style="margin-top: 20px"></div>

      <div style="margin-top: 30px">
        <button
          class="button"
          id="authButton"
          onclick="authenticateUser()"
          disabled
        >
          üîê Authenticate as Selected User
        </button>
        <button class="button secondary" onclick="logout()">
          üö™ Logout (Clear Session)
        </button>
        <button class="button secondary" onclick="goToApp()">
          üè† Go to PulseStage
        </button>
      </div>
    </div>

    <script>
      const API_URL = 'http://localhost:3000'
      let selectedUser = null
      let selectedTenant = null
      let allTenants = []

      // Initialize on page load
      async function init() {
        console.log('üîÑ Mock SSO: Initializing...')
        showLoading(true)

        try {
          // Fetch all tenants
          const response = await fetch(`${API_URL}/mock-sso/tenants`)
          if (!response.ok) {
            throw new Error(`Failed to fetch tenants: ${response.statusText}`)
          }

          const data = await response.json()
          allTenants = data.tenants || []

          console.log(`üìã Mock SSO: Found ${allTenants.length} tenant(s)`)

          if (allTenants.length === 0) {
            showStatus(
              '‚ö†Ô∏è No tenants found. Please run the setup wizard first.',
              'error'
            )
            showLoading(false)
            return
          }

          // If only one tenant, auto-select it
          if (allTenants.length === 1) {
            selectedTenant = allTenants[0].slug
            console.log(`‚úÖ Mock SSO: Auto-selected tenant: ${selectedTenant}`)
            await loadUsers(selectedTenant)
          } else {
            // Multiple tenants - show selector
            populateTenantSelector()
            document.getElementById('tenantSelector').style.display = 'block'
            showStatus(
              `üìå Found ${allTenants.length} tenants. Please select one to continue.`,
              'info'
            )
          }
        } catch (error) {
          console.error('‚ùå Mock SSO: Error initializing:', error)
          showStatus(`Failed to load tenants: ${error.message}`, 'error')
        } finally {
          showLoading(false)
        }
      }

      // Populate tenant selector dropdown
      function populateTenantSelector() {
        const select = document.getElementById('tenantSelect')
        select.innerHTML = '<option value="">-- Select a tenant --</option>'

        allTenants.forEach((tenant) => {
          const option = document.createElement('option')
          option.value = tenant.slug
          option.textContent = `${tenant.name} (${tenant.slug})`
          select.appendChild(option)
        })
      }

      // Handle tenant selection change
      async function onTenantChange() {
        const select = document.getElementById('tenantSelect')
        const tenantSlug = select.value

        if (!tenantSlug) {
          selectedTenant = null
          document.getElementById('usersList').innerHTML = ''
          document.getElementById('authButton').disabled = true
          return
        }

        selectedTenant = tenantSlug
        selectedUser = null
        console.log(`üîÑ Mock SSO: Tenant changed to: ${tenantSlug}`)

        await loadUsers(tenantSlug)
      }

      // Load users for selected tenant
      async function loadUsers(tenantSlug) {
        showLoading(true)
        document.getElementById('usersList').innerHTML = ''
        document.getElementById('authButton').disabled = true

        try {
          const response = await fetch(
            `${API_URL}/mock-sso/users/${tenantSlug}`
          )
          if (!response.ok) {
            throw new Error(`Failed to fetch users: ${response.statusText}`)
          }

          const data = await response.json()
          const users = data.users || []
          const tenant = data.tenant

          console.log(
            `üìã Mock SSO: Loaded ${users.length} user(s) for tenant: ${tenant.name}`
          )

          if (users.length === 0) {
            document.getElementById('usersList').innerHTML = `
              <div class="status info">
                ‚ÑπÔ∏è No users found for tenant "${tenant.name}". 
                <br/>Please create users through the setup wizard or admin panel.
              </div>
            `
            showStatus(`No users available for tenant "${tenant.name}"`, 'info')
            return
          }

          renderUsers(users, tenant)
          showStatus(
            `‚úÖ Loaded ${users.length} user(s) for "${tenant.name}". Select a user to authenticate.`,
            'success'
          )
        } catch (error) {
          console.error('‚ùå Mock SSO: Error loading users:', error)
          showStatus(`Failed to load users: ${error.message}`, 'error')
        } finally {
          showLoading(false)
        }
      }

      // Render users list
      function renderUsers(users, tenant) {
        const usersList = document.getElementById('usersList')

        let html = '<h3>Select a User to Authenticate As:</h3>'
        users.forEach((user) => {
          const roleClass = `role-${user.role}`
          html += `
            <div class="user-card" data-user="${user.email}">
              <div class="user-name">${user.name || 'No name'}</div>
              <div class="user-email">${user.email}</div>
              <span class="user-role ${roleClass}">${user.role}</span>
              <div class="teams">Teams: ${user.teams}</div>
            </div>
          `
        })

        usersList.innerHTML = html

        // Add click handlers to user cards
        document.querySelectorAll('.user-card').forEach((card) => {
          card.addEventListener('click', () => {
            document
              .querySelectorAll('.user-card')
              .forEach((c) => c.classList.remove('selected'))
            card.classList.add('selected')
            selectedUser = card.dataset.user
            document.getElementById('authButton').disabled = false
            console.log('‚úÖ Mock SSO: Selected user:', selectedUser)
          })
        })
      }

      // Authenticate user
      function authenticateUser() {
        if (!selectedTenant) {
          showStatus('Please select a tenant first!', 'error')
          return
        }

        if (!selectedUser) {
          showStatus('Please select a user first!', 'error')
          return
        }

        console.log(
          'üîê Mock SSO: Authenticating user:',
          selectedUser,
          'in tenant:',
          selectedTenant
        )

        // Set the mock SSO user and tenant in localStorage
        localStorage.setItem('mock-sso-user', selectedUser)
        localStorage.setItem('mock-tenant', selectedTenant)

        console.log('‚úÖ Mock SSO: Stored user and tenant in localStorage')

        // Dispatch custom event to notify app of the change
        window.dispatchEvent(new CustomEvent('mock-sso-changed'))

        showStatus(
          `‚úÖ Authenticated as ${selectedUser} in tenant "${selectedTenant}". Redirecting...`,
          'success'
        )

        // Auto-redirect to app after 2 seconds
        setTimeout(() => {
          console.log('üîÑ Mock SSO: Redirecting to main app...')
          window.location.href = '/'
        }, 2000)
      }

      // Logout
      function logout() {
        console.log('üö™ Mock SSO: Logging out...')
        localStorage.removeItem('mock-sso-user')
        localStorage.removeItem('mock-tenant')
        localStorage.removeItem('setup-tenant')
        localStorage.removeItem('setup-admin-email')
        localStorage.removeItem('setup-admin-user')

        // Dispatch custom event to notify app of the change
        window.dispatchEvent(new CustomEvent('mock-sso-changed'))

        selectedUser = null
        selectedTenant = null
        document.getElementById('usersList').innerHTML = ''
        document.getElementById('authButton').disabled = true

        showStatus('‚úÖ Logged out. Please select a tenant and user.', 'success')

        // Reload to show tenant selector
        init()
      }

      // Go to app
      function goToApp() {
        window.location.href = '/'
      }

      // Show/hide loading spinner
      function showLoading(show) {
        document.getElementById('loading').style.display = show
          ? 'block'
          : 'none'
      }

      // Show status message
      function showStatus(message, type) {
        const statusDiv = document.getElementById('status')
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`
      }

      // Initialize on page load
      window.addEventListener('DOMContentLoaded', init)
    </script>
  </body>
</html>
