<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mock SSO Testing - PulseStage (Multi-Tenant)</title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        margin-bottom: 30px;
      }
      .user-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        cursor: pointer;
        transition: all 0.2s;
      }
      .user-card:hover {
        border-color: #3b82f6;
        background: #f8faff;
      }
      .user-card.selected {
        border-color: #3b82f6;
        background: #eff6ff;
      }
      .user-name {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 5px;
      }
      .user-email {
        color: #666;
        margin-bottom: 10px;
      }
      .user-role {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
      }
      .role-admin {
        background: #fef3c7;
        color: #92400e;
      }
      .role-member {
        background: #d1fae5;
        color: #065f46;
      }
      .role-moderator {
        background: #d9f99d;
        color: #3f6212;
      }
      .role-owner {
        background: #e0e7ff;
        color: #3730a3;
      }
      .teams {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }
      .button {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
        margin: 10px 5px;
      }
      .button:hover {
        background: #2563eb;
      }
      .button.secondary {
        background: #6b7280;
      }
      .button.secondary:hover {
        background: #4b5563;
      }
      .status {
        padding: 15px;
        border-radius: 6px;
        margin: 20px 0;
        font-weight: 500;
      }
      .status.success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .status.error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .instructions {
        background: #f3f4f6;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 30px;
      }
      .instructions h3 {
        margin-top: 0;
        color: #374151;
      }
      .code {
        background: #1f2937;
        color: #f9fafb;
        padding: 15px;
        border-radius: 6px;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 14px;
        margin: 10px 0;
        overflow-x: auto;
      }
      .tenant-selector {
        background: #eff6ff;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
      }
      .tenant-selector label {
        font-weight: 600;
        font-size: 16px;
        display: block;
        margin-bottom: 10px;
      }
      .tenant-selector select {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #cbd5e1;
        border-radius: 6px;
        background: white;
      }
      .current-context {
        background: #d1fae5;
        border: 1px solid #a7f3d0;
        border-radius: 6px;
        padding: 15px;
        margin: 20px 0;
        font-weight: 500;
        color: #065f46;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Mock SSO Testing (Multi-Tenant)</h1>

      <div class="instructions">
        <h3>Demo User Selection</h3>
        <p>
          Select a demo user below to sign in and explore PulseStage with
          pre-populated data.
        </p>

        <h4>Multi-Tenancy Notes:</h4>
        <ul>
          <li>Users are permanently bound to their tenant</li>
          <li>You cannot switch tenants with the same user</li>
          <li>Each tenant has its own set of users, teams, and data</li>
          <li>The app will automatically use your tenant context</li>
        </ul>
      </div>

      <div
        id="currentContext"
        class="current-context"
        style="display: none"
      ></div>

      <div class="tenant-selector" id="tenantInfo">
        <label><span id="tenantLabel">Loading...</span></label>
        <p
          style="margin-top: 10px; font-size: 14px; color: #666"
          id="tenantDescription"
        >
          Loading user information...
        </p>
      </div>

      <div id="status"></div>

      <div id="usersList" style="margin-top: 20px"></div>

      <div style="margin-top: 30px">
        <button class="button" onclick="authenticateUser()">
          üîê Authenticate as Selected User
        </button>
        <button class="button secondary" onclick="logout()">
          üö™ Logout (Anonymous Mode)
        </button>
        <button class="button secondary" onclick="goToApp()">
          üè† Go to PulseStage
        </button>
      </div>

      <div style="margin-top: 30px">
        <h4>Manual Testing (Browser Console):</h4>
        <p>You can also test manually by adding this header to API requests:</p>
        <div class="code">
          # Test as John Doe (Admin) curl -H "x-mock-sso-user:
          john.doe@company.com" http://localhost:3000/users/me # Test as Jane
          Smith (Member) curl -H "x-mock-sso-user: jane.smith@company.com"
          http://localhost:3000/users/me # Test as Bob Wilson (Owner) curl -H
          "x-mock-sso-user: bob.wilson@company.com"
          http://localhost:3000/users/me
        </div>
      </div>
    </div>

    <script>
      let selectedUser = null
      let selectedTenant = null

      // Tenant-specific user data
      const tenantUsers = {
        default: [
          {
            email: 'john.doe@company.com',
            name: 'John Doe',
            role: 'admin',
            teams: 'Engineering (admin)',
          },
          {
            email: 'jane.smith@company.com',
            name: 'Jane Smith',
            role: 'member',
            teams: 'Engineering (member)',
          },
          {
            email: 'sarah@example.com',
            name: 'Sarah Wilson',
            role: 'moderator',
            teams: 'Engineering, Product (moderator)',
          },
          {
            email: 'mike@example.com',
            name: 'Mike Chen',
            role: 'moderator',
            teams: 'Design, Marketing (moderator)',
          },
          {
            email: 'bob.wilson@company.com',
            name: 'Bob Wilson',
            role: 'owner',
            teams: 'Product (owner)',
          },
        ],
        acme: [
          {
            email: 'alice.admin@acme.com',
            name: 'Alice Anderson',
            role: 'admin',
            teams: 'Engineering (admin)',
          },
          {
            email: 'charlie.owner@acme.com',
            name: 'Charlie Chen',
            role: 'owner',
            teams: 'Product (owner), Marketing (admin)',
          },
          {
            email: 'david@acme.com',
            name: 'David Martinez',
            role: 'moderator',
            teams: 'Engineering (moderator)',
          },
          {
            email: 'emily.member@acme.com',
            name: 'Emily Evans',
            role: 'member',
            teams: 'Engineering (member), Product (member)',
          },
        ],
      }

      // Auto-select tenant based on setup (default for default install, acme for demo)
      const setupTenant = localStorage.getItem('setup-tenant') || 'acme'
      selectedTenant = setupTenant

      // Update tenant info display
      const tenantLabel = document.getElementById('tenantLabel')
      const tenantDescription = document.getElementById('tenantDescription')
      if (setupTenant === 'default') {
        if (tenantLabel)
          tenantLabel.innerHTML = 'Your Organization: <strong>Default</strong>'
        if (tenantDescription)
          tenantDescription.textContent =
            'Sign in with your admin account to access your team.'
      } else {
        if (tenantLabel)
          tenantLabel.innerHTML = 'Demo Tenant: <strong>Acme Corp</strong>'
        if (tenantDescription)
          tenantDescription.textContent =
            'Choose a demo user below to sign in and explore the pre-configured teams and questions.'
      }

      renderUsers(setupTenant)

      // Render users for selected tenant
      function renderUsers(tenant) {
        let users = tenantUsers[tenant] || []

        // For default tenant, check if we have a dynamically created admin user
        if (tenant === 'default') {
          const setupAdminUser = localStorage.getItem('setup-admin-user')
          if (setupAdminUser) {
            try {
              const adminUser = JSON.parse(setupAdminUser)
              users = [
                {
                  email: adminUser.email,
                  name: adminUser.name,
                  role: adminUser.role,
                  teams: adminUser.teams,
                },
              ]
              // Clear it after reading
              localStorage.removeItem('setup-admin-user')
            } catch (e) {
              console.error('Failed to parse setup admin user:', e)
            }
          }
        }

        const usersList = document.getElementById('usersList')

        if (users.length === 0) {
          usersList.innerHTML =
            '<p style="color: #666; font-style: italic;">No users available for this tenant.</p>'
          return
        }

        let html = '<h3>Select a User to Authenticate As:</h3>'
        users.forEach((user) => {
          const roleClass = `role-${user.role}`
          html += `
                    <div class="user-card" data-user="${user.email}" data-tenant="${tenant}">
                        <div class="user-name">${user.name}</div>
                        <div class="user-email">${user.email}</div>
                        <span class="user-role ${roleClass}">${user.role}</span>
                        <div class="teams">Teams: ${user.teams}</div>
                    </div>
                `
        })

        usersList.innerHTML = html

        // Add click handlers to user cards
        document.querySelectorAll('.user-card').forEach((card) => {
          card.addEventListener('click', () => {
            document
              .querySelectorAll('.user-card')
              .forEach((c) => c.classList.remove('selected'))
            card.classList.add('selected')
            selectedUser = card.dataset.user
            console.log(
              'SSO Test: Selected user:',
              selectedUser,
              'in tenant:',
              tenant
            )
          })
        })
      }

      // Show current context
      function showCurrentContext() {
        const contextDiv = document.getElementById('currentContext')
        const currentUser = localStorage.getItem('mock-sso-user')
        const currentTenant = localStorage.getItem('mock-tenant')

        if (currentUser && currentTenant) {
          contextDiv.innerHTML = `üìå Current Context: <strong>${currentUser}</strong> in tenant <strong>${currentTenant}</strong>`
          contextDiv.style.display = 'block'
        }
      }

      // Hide current context
      function hideCurrentContext() {
        document.getElementById('currentContext').style.display = 'none'
      }

      // Authenticate user
      function authenticateUser() {
        if (!selectedTenant) {
          showStatus('Please select a tenant first!', 'error')
          return
        }

        if (!selectedUser) {
          showStatus('Please select a user first!', 'error')
          return
        }

        console.log(
          'SSO Test: Authenticating user:',
          selectedUser,
          'in tenant:',
          selectedTenant
        )

        // Set the mock SSO user and tenant in localStorage
        localStorage.setItem('mock-sso-user', selectedUser)
        localStorage.setItem('mock-tenant', selectedTenant)

        console.log('SSO Test: Stored user and tenant in localStorage')

        // Dispatch custom event to notify app of the change
        window.dispatchEvent(new CustomEvent('mock-sso-changed'))

        showStatus(
          `‚úÖ Authenticated as ${selectedUser} in tenant "${selectedTenant}". Redirecting...`,
          'success'
        )
        showCurrentContext()

        // Auto-redirect to app after 2 seconds
        setTimeout(() => {
          console.log('SSO Test: Redirecting to main app...')
          window.location.href = '/'
        }, 2000)
      }

      // Logout
      function logout() {
        localStorage.removeItem('mock-sso-user')
        localStorage.removeItem('mock-tenant')

        // Dispatch custom event to notify app of the change
        window.dispatchEvent(new CustomEvent('mock-sso-changed'))

        selectedUser = null
        selectedTenant = 'acme'
        document.getElementById('usersList').innerHTML = ''
        renderUsers('acme')

        hideCurrentContext()
        showStatus('üö™ Logged out. Now in anonymous mode.', 'success')
      }

      // Go to app
      function goToApp() {
        window.location.href = '/'
      }

      // Show status message
      function showStatus(message, type) {
        const statusDiv = document.getElementById('status')
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`
      }

      // Initialize on page load
      window.addEventListener('DOMContentLoaded', () => {
        const currentUser = localStorage.getItem('mock-sso-user')
        const setupAdminEmail = localStorage.getItem('setup-admin-email')
        const currentTenant = localStorage.getItem('mock-tenant') || 'acme'

        if (currentUser && currentTenant) {
          // Set the tenant
          selectedTenant = currentTenant

          // Render users for that tenant (always acme for demo)
          renderUsers('acme')

          // Highlight the current user
          setTimeout(() => {
            document.querySelectorAll('.user-card').forEach((card) => {
              if (card.dataset.user === currentUser) {
                card.classList.add('selected')
                selectedUser = currentUser
              }
            })
          }, 100)

          showCurrentContext()
        } else if (setupAdminEmail) {
          // New admin just created - show welcome message
          const statusDiv = document.getElementById('status')
          if (statusDiv) {
            statusDiv.innerHTML = `
              <div style="background: #eff6ff; border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="color: #1e40af; margin: 0 0 10px 0;">üëã Welcome, Admin!</h3>
                <p style="color: #1e40af; margin: 0;">Your account <strong>${setupAdminEmail}</strong> has been created as the team owner.</p>
                <p style="color: #1e40af; margin: 10px 0 0 0; font-size: 14px;">Click "Sign In" below to access your team.</p>
              </div>
            `
          }

          // Clear the setup flag
          localStorage.removeItem('setup-admin-email')

          // Auto-select the admin user
          selectedUser = setupAdminEmail

          // Highlight their card
          setTimeout(() => {
            document.querySelectorAll('.user-card').forEach((card) => {
              if (card.dataset.user === setupAdminEmail) {
                card.classList.add('selected')
                card.scrollIntoView({ behavior: 'smooth', block: 'center' })
              }
            })
          }, 100)
        }
      })
    </script>
  </body>
</html>
